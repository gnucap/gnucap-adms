#!/bin/bash

usage="type $0 some.va to generate some.cc and some.h. \n
\n
to get a shared object type \n
make some.o CXXFLAGS=\"--shared\ -fPIC\" CPPFLAGS=$(gnucap-conf --cppflags)\ LDFLAGS=\ \n
mv some.o some.so"

function check_gnucap {
	[ -z `which gnucap-conf` ] &&  echo "need gnucap-conf" && exit 1 
}

function check_adms {
	[ -z `which admsXml` ] &&  echo "need admsXml" && exit 1 
}

check_gnucap

prefix=@prefix@
adms_dbg_xml=no
compile=no
quiet=no
verbose=no
gnucap_libdir=@gnucap_libdir@
ES=$(echo "-e@datarootdir@/gnucap-adms/gnucap_"{0,1,2}.xml)
RPATH=-Wl,-rpath,@libdir@
trace=
opt=0
ndebug=
gdb=
cppflags=-I@includedir@/@PACKAGE@ 

for arg in $*; do
	case $arg in
		*.va)
			check_adms
			cmd="admsXml -I@includedir@/@PACKAGE@ $ES $arg -o ${arg%.va}"
			[ $verbose = no ] || echo $cmd
			$cmd

			if [ $compile = yes ]; then
				cmd="@CXX@ $ndebug $trace $gdb -O$opt $cppflags $(gnucap-conf --cppflags) -shared -fPIC \
				    ${arg%.va}.cc -L@libdir@ -le_adms -o ${arg%.va}.so $RPATH"
				[ $quiet = no ] && echo compiling ${arg%.va}.so
				[ $verbose = no ] || echo $cmd
				$cmd
			fi
			;;
		*.cc)
			cmd="@CXX@ $ndebug $trace $gdb -O$opt $cppflags $(gnucap-conf --cppflags) -shared -fPIC \
				$arg -L@libdir@ -le_adms -o ${arg%.cc}.so $RPATH"
			[ $quiet = no ] && echo compiling ${arg%.cc}.so
			[ $verbose = no ] || echo $cmd
			$cmd
			;;
		--compile|-c)
			compile=yes
			;;
		--verbose|-v)
			verbose=yes
			;;
		--trace|-t)
			trace=-DDO_TRACE
			;;
		--gdb|-g)
			gdb=-g
			;;
		--opt|-o)
			ndebug=-DNDEBUG
			opt=$(expr $opt + 1)
			;;
		--quiet|-q)
			quiet=yes
			;;
		--debug|-d)
			adms_dbg_xml=yes
			;;
		--cppflags)
			echo $cppflags
			exit 0
			;;
		--help|*)
			echo -e $usage
			exit 0
			;;
	esac
done

